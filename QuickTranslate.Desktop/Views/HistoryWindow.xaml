<ui:FluentWindow x:Class="QuickTranslate.Desktop.Views.HistoryWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:QuickTranslate.Desktop.Services"
        xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
        xmlns:converters="clr-namespace:QuickTranslate.Desktop.Converters"
        mc:Ignorable="d"
        Title="{Binding [History], Source={x:Static local:Loc.Instance}}" 
        Height="600" 
        Width="800"
        MinHeight="400"
        MinWidth="500"
        WindowStartupLocation="CenterOwner"
        Background="{DynamicResource ApplicationBackgroundBrush}"
        Foreground="{DynamicResource TextFillColorPrimaryBrush}"
        ExtendsContentIntoTitleBar="True"
        WindowBackdropType="Mica">
    
    <Window.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVis"/>
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVis"/>
        <converters:FavoriteIconConverter x:Key="FavoriteIconConverter"/>
        <converters:FavoriteColorConverter x:Key="FavoriteColorConverter"/>
        <converters:TimestampConverter x:Key="TimestampConverter"/>
        <converters:ZeroToVisibilityConverter x:Key="ZeroToVisibilityConverter"/>
    </Window.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        
        <ui:TitleBar Grid.Row="0" 
                    Title="{Binding [History], Source={x:Static local:Loc.Instance}}"
                    ShowMaximize="True"
                    ShowMinimize="True"/>
        
        <Grid Grid.Row="1" Margin="16,8,16,16">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            
            <!-- Search and Filter Bar -->
            <ui:Card Grid.Row="0" Margin="0,0,0,12">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Search Box -->
                    <ui:TextBox Grid.Column="0"
                               PlaceholderText="{Binding [SearchHistory], Source={x:Static local:Loc.Instance}}"
                               Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                               Icon="{ui:SymbolIcon Search24}"/>
                    
                    <!-- Favorites Toggle -->
                    <ToggleButton Grid.Column="1"
                                  IsChecked="{Binding ShowFavoritesOnly}"
                                  ToolTip="{Binding [ShowFavoritesOnly], Source={x:Static local:Loc.Instance}}"
                                  Margin="12,0,0,0"
                                  Padding="10,6">
                        <StackPanel Orientation="Horizontal">
                            <ui:SymbolIcon Symbol="Star24" FontSize="16" Margin="0,0,6,0"/>
                            <TextBlock Text="{Binding [Favorites], Source={x:Static local:Loc.Instance}}" 
                                       VerticalAlignment="Center"/>
                        </StackPanel>
                    </ToggleButton>
                    
                    <!-- Clear Button -->
                    <ui:Button Grid.Column="2"
                               Command="{Binding ClearHistoryCommand}"
                               Appearance="Secondary"
                               ToolTip="{Binding [ClearHistory], Source={x:Static local:Loc.Instance}}"
                               Margin="8,0,0,0">
                        <StackPanel Orientation="Horizontal">
                            <ui:SymbolIcon Symbol="Delete24" FontSize="16" Margin="0,0,6,0"/>
                            <TextBlock Text="{Binding [Clear], Source={x:Static local:Loc.Instance}}" 
                                       VerticalAlignment="Center"/>
                        </StackPanel>
                    </ui:Button>
                </Grid>
            </ui:Card>
            
            <!-- History List -->
            <ListView Grid.Row="1"
                      ItemsSource="{Binding HistoryItems}"
                      SelectedItem="{Binding SelectedItem}"
                      ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                      Background="Transparent"
                      BorderThickness="0">
                <ListView.ItemContainerStyle>
                    <Style TargetType="ListViewItem">
                        <Setter Property="Padding" Value="0"/>
                        <Setter Property="Margin" Value="0,0,0,8"/>
                        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                        <Setter Property="Background" Value="Transparent"/>
                        <Setter Property="BorderThickness" Value="0"/>
                    </Style>
                </ListView.ItemContainerStyle>
                <ListView.ItemTemplate>
                    <DataTemplate>
                        <ui:Card Padding="12">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                
                                <!-- Header: Time, Language, Actions -->
                                <Grid Grid.Row="0" Margin="0,0,0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <!-- Timestamp -->
                                    <TextBlock Grid.Column="0"
                                               Text="{Binding Timestamp, Converter={StaticResource TimestampConverter}}"
                                               Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                                               FontSize="11"
                                               VerticalAlignment="Center"/>
                                    
                                    <!-- Language Badge -->
                                    <Border Grid.Column="1"
                                            Background="{DynamicResource AccentFillColorDefaultBrush}"
                                            CornerRadius="4"
                                            Padding="6,2"
                                            Margin="10,0,0,0">
                                        <TextBlock Text="{Binding TargetLanguage}"
                                                   Foreground="White"
                                                   FontSize="11"
                                                   FontWeight="SemiBold"/>
                                    </Border>
                                    
                                    <!-- Provider -->
                                    <TextBlock Grid.Column="2"
                                               Text="{Binding ProviderName}"
                                               Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                                               FontSize="11"
                                               Margin="10,0,0,0"
                                               VerticalAlignment="Center"/>
                                    
                                    <!-- Actions -->
                                    <StackPanel Grid.Column="3" Orientation="Horizontal">
                                        <ui:Button Appearance="Transparent"
                                                   Command="{Binding DataContext.ToggleFavoriteCommand, RelativeSource={RelativeSource AncestorType=ListView}}"
                                                   CommandParameter="{Binding}"
                                                   ToolTip="{Binding [ToggleFavorite], Source={x:Static local:Loc.Instance}}"
                                                   Padding="6">
                                            <ui:SymbolIcon Symbol="Star24" 
                                                           FontSize="14"
                                                           Foreground="{Binding IsFavorite, Converter={StaticResource FavoriteColorConverter}}"/>
                                        </ui:Button>
                                        <ui:Button Appearance="Transparent"
                                                   Command="{Binding DataContext.UseItemCommand, RelativeSource={RelativeSource AncestorType=ListView}}"
                                                   CommandParameter="{Binding}"
                                                   ToolTip="{Binding [UseThisTranslation], Source={x:Static local:Loc.Instance}}"
                                                   Padding="6">
                                            <ui:SymbolIcon Symbol="ArrowExportUp24" FontSize="14"/>
                                        </ui:Button>
                                        <ui:Button Appearance="Transparent"
                                                   Command="{Binding DataContext.DeleteItemCommand, RelativeSource={RelativeSource AncestorType=ListView}}"
                                                   CommandParameter="{Binding}"
                                                   ToolTip="{Binding [Delete], Source={x:Static local:Loc.Instance}}"
                                                   Padding="6">
                                            <ui:SymbolIcon Symbol="Delete24" FontSize="14"
                                                           Foreground="{DynamicResource SystemFillColorCriticalBrush}"/>
                                        </ui:Button>
                                    </StackPanel>
                                </Grid>
                                
                                <!-- Source Text -->
                                <Grid Grid.Row="1" Margin="0,0,0,6">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0"
                                               Text="{Binding SourceText}"
                                               TextTrimming="CharacterEllipsis"
                                               MaxHeight="40"
                                               Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                               FontSize="12"/>
                                    <ui:Button Grid.Column="1"
                                               Appearance="Transparent"
                                               Command="{Binding DataContext.CopySourceCommand, RelativeSource={RelativeSource AncestorType=ListView}}"
                                               CommandParameter="{Binding}"
                                               ToolTip="{Binding [CopySource], Source={x:Static local:Loc.Instance}}"
                                               Padding="4"
                                               VerticalAlignment="Top">
                                        <ui:SymbolIcon Symbol="Copy24" FontSize="12"/>
                                    </ui:Button>
                                </Grid>
                                
                                <!-- Translation -->
                                <Grid Grid.Row="2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0"
                                               Text="{Binding TranslatedText}"
                                               TextTrimming="CharacterEllipsis"
                                               MaxHeight="40"
                                               Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                                               FontSize="13"
                                               FontWeight="Medium"/>
                                    <ui:Button Grid.Column="1"
                                               Appearance="Transparent"
                                               Command="{Binding DataContext.CopyTranslationCommand, RelativeSource={RelativeSource AncestorType=ListView}}"
                                               CommandParameter="{Binding}"
                                               ToolTip="{Binding [CopyTranslation], Source={x:Static local:Loc.Instance}}"
                                               Padding="4"
                                               VerticalAlignment="Top">
                                        <ui:SymbolIcon Symbol="Copy24" FontSize="12"/>
                                    </ui:Button>
                                </Grid>
                            </Grid>
                        </ui:Card>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
            
            <!-- Empty State -->
            <StackPanel Grid.Row="1"
                        VerticalAlignment="Center"
                        HorizontalAlignment="Center"
                        Visibility="{Binding HistoryItems.Count, Converter={StaticResource ZeroToVisibilityConverter}}">
                <ui:SymbolIcon Symbol="History24" FontSize="48"
                               Foreground="{DynamicResource TextFillColorTertiaryBrush}"/>
                <TextBlock Text="{Binding [NoHistoryItems], Source={x:Static local:Loc.Instance}}"
                           Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                           FontSize="14"
                           Margin="0,12,0,0"/>
            </StackPanel>
            
            <!-- Status Bar -->
            <TextBlock Grid.Row="2"
                       Text="{Binding StatusMessage}"
                       Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                       FontSize="12"
                       Margin="0,8,0,0"/>
        </Grid>
    </Grid>
</ui:FluentWindow>
